<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aqua Control</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’§</text></svg>">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    * { transition: background-color 0.2s, border-color 0.2s, color 0.15s; }
    .dk { --tw-bg-opacity:1; }
    /* Fondo general */
    .dk.min-h-screen { background-color: #0f172a !important; }
    /* Cards / paneles blancos */
    .dk .bg-white  { background-color: #1e293b !important; }
    .dk .bg-slate-50  { background-color: #0f172a !important; }
    .dk .bg-slate-100 { background-color: #1e293b !important; }
    .dk .bg-slate-200 { background-color: #334155 !important; }
    /* Bordes */
    .dk .border-slate-100,
    .dk .border-slate-200 { border-color: #334155 !important; }
    .dk .border-t         { border-color: #334155 !important; }
    /* Textos */
    .dk .text-slate-800 { color: #f1f5f9 !important; }
    .dk .text-slate-700 { color: #e2e8f0 !important; }
    .dk .text-slate-600 { color: #cbd5e1 !important; }
    .dk .text-slate-500 { color: #94a3b8 !important; }
    .dk .text-slate-400 { color: #64748b !important; }
    /* Inputs y selects */
    .dk input, .dk select, .dk textarea {
      background-color: #1e293b !important;
      border-color: #475569 !important;
      color: #e2e8f0 !important;
    }
    .dk select option { background-color: #1e293b; color: #e2e8f0; }
    /* Colores semÃ¡nticos */
    .dk .text-emerald-600 { color: #34d399 !important; }
    .dk .text-red-500     { color: #f87171 !important; }
    .dk .text-blue-600    { color: #60a5fa !important; }
    .dk .bg-emerald-50    { background-color: #022c22 !important; }
    .dk .bg-red-50        { background-color: #2d0a0a !important; }
    .dk .bg-blue-50       { background-color: #0c1a2e !important; }
    /* Sombras */
    .dk .shadow-sm { box-shadow: 0 1px 3px rgba(0,0,0,0.6) !important; }
    /* Nav header oscuro */
    .dk-nav { background-color: #1e293b !important; border-color: #334155 !important; }
    /* BotÃ³n deshabilitado en dark */
    .dk .cursor-not-allowed.bg-slate-200 { background-color: #1e293b !important; color: #475569 !important; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBiI3Wo7zP2rHZZ9b061OJ6a3lilRM02vc",
      authDomain: "reparto-agua-3d2bf.firebaseapp.com",
      projectId: "reparto-agua-3d2bf",
      storageBucket: "reparto-agua-3d2bf.firebasestorage.app",
      messagingSenderId: "954623535383",
      appId: "1:954623535383:web:6b54c07a9778295a1eaf52",
      measurementId: "G-9VLZL1CZH5"
    };
    firebase.initializeApp(firebaseConfig);
    const db   = firebase.firestore();
    const auth = firebase.auth();
  </script>
  <script type="text/babel" data-presets="react">
    const { useState, useCallback, useEffect } = React;
const NAFTA_GIF = "nafta.gif";



// â”€â”€â”€ GIFs embebidos en base64 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const gifBidon20 = "bidon20.gif";
const gifCajon   = "cajon.gif";
const gifBidon12 = "bidon12.gif";

const gifCredito = "credito.gif";

const PRODUCT_GIFS = {
  bidon20: gifCajon,
  bidon12: gifBidon20,
  cajon:   gifBidon12,
};

function ProductIcon({ id, size = 32 }) {
  const src = PRODUCT_GIFS[id];
  if (!src) return null;
  return <img src={src} alt={id} style={{ width: size, height: size, objectFit: "contain" }} />;
}

// â”€â”€â”€ Constantes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_CONFIG = {
  productos: [
    { id: "bidon20", nombre: "BidÃ³n 20L",  emoji: "ğŸ«§", precioVenta: 400, gananciaUnidad: 108.56 },
    { id: "bidon12", nombre: "BidÃ³n 12L",  emoji: "ğŸ’§", precioVenta: 280, gananciaUnidad: 93.34  },
    { id: "cajon",   nombre: "CajÃ³n Soda", emoji: "ğŸ“¦", precioVenta: 234, gananciaUnidad: 78     },
  ],
  gastoNafta: 500,
};

const TABS = ["Cierre", "Historial", "Resumen", "Reportes", "Exportar", "Config"];
const STORAGE_KEYS = { config: "aguaConfig", cierres: "aguaCierres" };

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = (n) =>
  `$${Number(n).toLocaleString("es-AR", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

const today = () => new Date().toISOString().split("T")[0];
const esDomingo = (dateStr) => new Date(dateStr + "T12:00:00").getDay() === 0;

// "2026-02-21" â†’ "21/02/26"
const fmtFecha = (dateStr) => {
  if (!dateStr) return "";
  const [y, m, d] = dateStr.split("-");
  return `${d}/${m}/${y.slice(2)}`;
};

function calcularCierre(cantidades, credito, noTrabajo, config) {
  if (noTrabajo) {
    return {
      totalVendido: 0, gananciaProductos: 0, pagoFabricaBase: 0,
      descuentoCredito: 0, pagoFabrica: 0, gastoNafta: 0, gananciaFinal: 0,
    };
  }
  let totalVendido = 0, gananciaProductos = 0, pagoFabricaBase = 0;
  config.productos.forEach((p) => {
    const qty = Number(cantidades[p.id] || 0);
    totalVendido      += qty * p.precioVenta;
    gananciaProductos += qty * p.gananciaUnidad;
    pagoFabricaBase   += qty * (p.precioVenta - p.gananciaUnidad);
  });
  const precioB20 = config.productos.find((p) => p.id === "bidon20")?.precioVenta || 400;
  const descuentoCredito = Number(credito || 0) * precioB20;
  const pagoFabrica = Math.max(0, pagoFabricaBase - descuentoCredito);
  const gastoNafta = config.gastoNafta;
  const gananciaFinal = gananciaProductos - gastoNafta;
  return { totalVendido, gananciaProductos, pagoFabricaBase, descuentoCredito, pagoFabrica, gastoNafta, gananciaFinal };
}

function loadStorage(key, fallback) {
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  catch { return fallback; }
}
function saveStorage(key, value) {
  try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
}

// â”€â”€â”€ Firebase / Firestore helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const userDoc    = (uid) => db.collection("users").doc(uid);
const cierresCol = (uid) => userDoc(uid).collection("cierres");

async function fsLoadConfig(uid) {
  const snap = await userDoc(uid).get();
  return (snap.exists && snap.data().config) ? snap.data().config : DEFAULT_CONFIG;
}
async function fsSaveConfig(uid, config) {
  await userDoc(uid).set({ config }, { merge: true });
}
async function fsLoadCierres(uid) {
  const snap = await cierresCol(uid).get();
  return snap.docs.map(d => d.data());
}
async function fsSaveCierre(uid, cierre) {
  await cierresCol(uid).doc(String(cierre.id)).set(cierre);
}
async function fsDeleteCierre(uid, id) {
  await cierresCol(uid).doc(String(id)).delete();
}

// â”€â”€â”€ Componentes auxiliares â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Card({ children, className = "" }) {
  return (
    <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 ${className}`}>
      {children}
    </div>
  );
}

function ResultRow({ label, value, highlight = false, big = false, muted = false, negative = false }) {
  return (
    <div className={`flex justify-between items-center py-2 ${big ? "border-t border-slate-200 mt-1 pt-3" : ""}`}>
      <span className={`${big ? "font-semibold text-base" : "text-sm"} ${muted ? "text-slate-400" : "text-slate-600"}`}>
        {label}
      </span>
      <span className={`font-bold tabular-nums ${
        highlight ? "text-emerald-600 text-xl" : negative ? "text-red-500 text-sm" : big ? "text-slate-800 text-lg" : muted ? "text-slate-400 text-sm" : "text-slate-800 text-sm"
      }`}>
        {value}
      </span>
    </div>
  );
}

// â”€â”€â”€ Login Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoginScreen() {
  const [email,   setEmail]   = useState("");
  const [pass,    setPass]    = useState("");
  const [error,   setError]   = useState("");
  const [loading, setLoading] = useState(false);

  const handleLogin = async () => {
    if (!email || !pass) { setError("CompletÃ¡ los campos."); return; }
    setError(""); setLoading(true);
    try {
      await auth.signInWithEmailAndPassword(email, pass);
    } catch (e) {
      const code = e.code || "";
      if (code === "auth/unauthorized-domain") {
        setError("âš ï¸ Dominio no autorizado. AbrÃ­ la app desde GitHub Pages (HTTPS), no desde el archivo local.");
      } else if (code === "auth/user-not-found" || code === "auth/wrong-password" || code === "auth/invalid-credential") {
        setError("Email o contraseÃ±a incorrectos.");
      } else if (code === "auth/network-request-failed") {
        setError("Sin conexiÃ³n. VerificÃ¡ tu internet.");
      } else if (code === "auth/too-many-requests") {
        setError("Demasiados intentos. EsperÃ¡ unos minutos.");
      } else {
        setError("Error: " + (e.message || code));
      }
    }
    setLoading(false);
  };

  return (
    <div className="min-h-screen bg-slate-50 flex items-center justify-center px-4">
      <div className="w-full max-w-sm">
        <div className="text-center mb-8">
          <div className="text-5xl mb-3">ğŸ’§</div>
          <h1 className="text-2xl font-extrabold text-slate-800">Aqua Control</h1>
          <p className="text-slate-400 text-sm mt-1">IniciÃ¡ sesiÃ³n para continuar</p>
        </div>
        <Card className="p-6 space-y-4">
          <div>
            <label className="block text-sm font-medium text-slate-600 mb-1">Email</label>
            <input type="email" value={email} onChange={e => setEmail(e.target.value)}
              className="w-full border border-slate-200 rounded-xl px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400" />
          </div>
          <div>
            <label className="block text-sm font-medium text-slate-600 mb-1">ContraseÃ±a</label>
            <input type="password" value={pass} onChange={e => setPass(e.target.value)}
              onKeyDown={e => e.key === "Enter" && handleLogin()}
              className="w-full border border-slate-200 rounded-xl px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400" />
          </div>
          {error && <p className="text-red-500 text-sm text-center">{error}</p>}
          <button onClick={handleLogin} disabled={loading}
            className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white font-bold py-4 rounded-2xl text-base transition-colors">
            {loading ? "Ingresando..." : "Ingresar"}
          </button>
        </Card>
      </div>
    </div>
  );
}

// â”€â”€â”€ Tab: Cierre â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TabCierre({ config, cierres, onSave }) {
  const [fecha,      setFecha]      = useState(today);
  const [cantidades, setCantidades] = useState({});
  const [credito,    setCredito]    = useState("");
  const [noTrabajo,  setNoTrabajo]  = useState(false);
  const [resultado,  setResultado]  = useState(null);
  const [saved,      setSaved]      = useState(false);
  const [error,      setError]      = useState("");
  const [calcFlash,  setCalcFlash]  = useState(false);

  const fechaEsDomingo = esDomingo(fecha);

  const handleFecha = (val) => {
    setFecha(val); setResultado(null); setSaved(false); setError("");
  };

  const handleNoTrabajo = (checked) => {
    setNoTrabajo(checked);
    if (checked) { setCantidades({}); setCredito(""); }
    setResultado(null); setSaved(false);
  };

  const handleCalc = () => {
    setError("");
    if (fechaEsDomingo) { setError("El domingo no se trabaja. ElegÃ­ otra fecha."); return; }
    for (const p of config.productos) {
      const v = cantidades[p.id];
      if (v !== undefined && v !== "" && (isNaN(Number(v)) || Number(v) < 0)) {
        setError(`Cantidad invÃ¡lida en ${p.nombre}`); return;
      }
    }
    if (credito !== "" && (isNaN(Number(credito)) || Number(credito) < 0)) {
      setError("El crÃ©dito no puede ser negativo."); return;
    }
    const res = calcularCierre(cantidades, credito, noTrabajo, config);
    if (!noTrabajo && res.descuentoCredito > res.pagoFabricaBase) {
      setError(`âš ï¸ El crÃ©dito (${fmt(res.descuentoCredito)}) supera el pago a fÃ¡brica (${fmt(res.pagoFabricaBase)}). El pago quedarÃ¡ en $0.`);
    }
    setResultado(res); setSaved(false);
    setCalcFlash(true); setTimeout(() => setCalcFlash(false), 600);
  };

  const handleSave = () => {
    if (!resultado) return;
    if (fechaEsDomingo) { setError("No se puede guardar un cierre en domingo."); return; }
    if (cierres.find((c) => c.fecha === fecha)) {
      setError("Ya existe un cierre para esta fecha. Eliminalo desde Historial para reemplazarlo."); return;
    }
    onSave({ fecha, cantidades: { ...cantidades }, credito: Number(credito || 0), noTrabajo, ...resultado, id: Date.now() });
    setSaved(true); setError("");
    setCantidades({}); setCredito("");
  };

  return (
    <div className="space-y-4">
      <Card className="p-4">
        <h2 className="text-lg font-bold text-slate-800 mb-4">ğŸ“‹ Cierre del dÃ­a</h2>

        {/* Fecha */}
        <div className="mb-4">
          <label className="block text-sm font-medium text-slate-600 mb-1">Fecha</label>
          <input type="date" value={fecha} onChange={(e) => handleFecha(e.target.value)}
            className="w-full border border-slate-200 rounded-xl px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400 box-border appearance-none" style={{WebkitAppearance:"none"}} />
          {fechaEsDomingo && (
            <p className="text-xs text-red-500 mt-1 bg-red-50 rounded-lg px-2 py-1">â›” Domingo â€” no se trabaja. ElegÃ­ otra fecha.</p>
          )}
        </div>

        {/* Checkbox no trabajÃ³ */}
        <label className="flex items-center gap-3 mb-5 cursor-pointer select-none">
          <input type="checkbox" checked={noTrabajo} onChange={(e) => handleNoTrabajo(e.target.checked)}
            className="w-5 h-5 rounded accent-blue-600" />
          <span className="text-sm text-slate-700 font-medium">Ese dÃ­a no se trabajÃ³</span>
        </label>

        {/* Productos */}
        <div className={`space-y-3 ${noTrabajo ? "opacity-40 pointer-events-none" : ""}`}>
          {config.productos.map((p) => (
            <div key={p.id} className="flex items-center gap-3">
              <span className="w-8 flex items-center justify-center"><ProductIcon id={p.id} size={32} /></span>
              <div className="flex-1">
                <div className="text-sm font-medium text-slate-700">{p.nombre}</div>
                <div className="text-xs text-slate-400">Ganancia: {fmt(p.gananciaUnidad)} c/u</div>
              </div>
              <input
                type="number" inputMode="numeric" min="0" placeholder="0"
                value={cantidades[p.id] || ""}
                onChange={(e) => { setCantidades((prev) => ({ ...prev, [p.id]: e.target.value })); setResultado(null); setSaved(false); }}
                className="w-20 border border-slate-200 rounded-xl px-3 py-3 text-center text-lg font-bold focus:outline-none focus:ring-2 focus:ring-blue-400"
              />
            </div>
          ))}

          {/* CrÃ©dito */}
          <div className="flex items-center gap-3 pt-2 mt-1">
            <span className="w-8 flex items-center justify-center"><img src={gifCredito} alt="credito" style={{ width: 32, height: 32, objectFit: "contain" }} /></span>
            <div className="flex-1">
              <div className="text-sm font-medium text-slate-700">CrÃ©dito (Bid. 20L)</div>
              <div className="text-xs text-slate-400">Descuenta del pago a fÃ¡brica</div>
            </div>
            <input
              type="number" inputMode="numeric" min="0" placeholder="0"
              value={credito}
              onChange={(e) => { setCredito(e.target.value); setResultado(null); setSaved(false); }}
              className="w-20 border border-slate-200 bg-white rounded-xl px-3 py-3 text-center text-lg font-bold focus:outline-none focus:ring-2 focus:ring-blue-400"
            />
          </div>
        </div>

        {error && <p className="mt-3 text-sm text-amber-700 bg-amber-50 rounded-xl px-3 py-2">{error}</p>}

        <button onClick={handleCalc} disabled={fechaEsDomingo}
          className={`w-full mt-5 text-white font-bold py-4 rounded-2xl text-base transition-colors disabled:bg-slate-300 disabled:cursor-not-allowed ${calcFlash ? "bg-blue-400 scale-95" : "bg-blue-600 hover:bg-blue-700 active:bg-blue-800"}`}>
          {calcFlash ? "âœ“ Calculado" : "Calcular"}
        </button>
      </Card>

      {/* Resultado */}
      {resultado && (
        <Card className="p-4">
          <h3 className="text-base font-bold text-slate-700 mb-3">ğŸ“Š Resultado del dÃ­a</h3>
          {noTrabajo ? (
            <p className="text-center text-slate-400 text-sm py-2">DÃ­a sin actividad â€” todo en $0</p>
          ) : (
            <>
              <ResultRow label="Total vendido"     value={fmt(resultado.totalVendido)} />
              <ResultRow label="Pago a fÃ¡brica"    value={fmt(resultado.pagoFabrica)} />
              {resultado.descuentoCredito > 0 && (
                <ResultRow label="Descuento crÃ©dito" value={`- ${fmt(resultado.descuentoCredito)}`} negative />
              )}
              <ResultRow label="Gasto nafta"        value={`- ${fmt(resultado.gastoNafta)}`} negative />
            </>
          )}
          <ResultRow label="Ganancia final" value={fmt(resultado.gananciaFinal)} highlight big />

          {saved ? (
            <div className="mt-4 text-center text-emerald-600 font-semibold text-sm bg-emerald-50 rounded-xl py-3">Cierre guardado</div>
          ) : (
            <button onClick={handleSave}
              className="w-full mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl text-base transition-colors">
              Guardar cierre
            </button>
          )}
        </Card>
      )}
    </div>
  );
}

// â”€â”€â”€ Tab: Historial â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TabHistorial({ cierres, config, onDelete }) {
  const now  = new Date();
  const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio",
                 "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  const [selected,   setSelected]   = useState(null);
  const [confirmDel, setConfirmDel] = useState(null);
  const [mes,  setMes]  = useState(String(now.getMonth() + 1).padStart(2, "0"));
  const [anio, setAnio] = useState(String(now.getFullYear()));
  const prefix = `${anio}-${mes}`;
  const sorted = [...cierres]
    .filter(c => c.fecha.startsWith(prefix))
    .sort((a, b) => b.fecha.localeCompare(a.fecha));

  // â”€â”€ Vista detalle â”€â”€
  if (selected) {
    const c = cierres.find((x) => x.id === selected);
    if (!c) { setSelected(null); return null; }
    return (
      <div className="space-y-4">
        <button onClick={() => { setSelected(null); setConfirmDel(null); }}
          className="flex items-center gap-2 text-blue-600 font-medium text-sm">
          â† Volver al historial
        </button>
        <Card className="p-4">
          <h2 className="text-lg font-bold text-slate-800 mb-1">Cierre del {fmtFecha(c.fecha)}</h2>
          {c.noTrabajo ? (
            <p className="text-slate-400 text-sm my-3">DÃ­a sin actividad registrado.</p>
          ) : (
            <div className="space-y-2 my-3">
              {config.productos.map((p) => {
                const qty = Number(c.cantidades?.[p.id] || 0);
                if (!qty) return null;
                return (
                  <div key={p.id} className="flex justify-between text-sm">
                    <span className="text-slate-600 flex items-center gap-1"><ProductIcon id={p.id} size={20} /> {p.nombre} Ã— {qty}</span>
                    <span className="font-medium text-slate-800">{fmt(qty * p.precioVenta)}</span>
                  </div>
                );
              })}
              {c.credito > 0 && (
                <div className="flex justify-between text-sm">
                  <span className="text-slate-600 flex items-center gap-1"><img src={gifCredito} alt="credito" style={{ width: 20, height: 20, objectFit: "contain" }} /> CrÃ©dito Ã— {c.credito} bidones</span>
                  <span className="text-slate-800 font-medium text-sm">{fmt(c.descuentoCredito)}</span>
                </div>
              )}
            </div>
          )}
          <ResultRow label="Total vendido"    value={fmt(c.totalVendido)} />
          <ResultRow label="Pago a fÃ¡brica"   value={fmt(c.pagoFabrica)} />
          {c.descuentoCredito > 0 && <ResultRow label="Descuento crÃ©dito" value={`- ${fmt(c.descuentoCredito)}`} negative />}
          <ResultRow label="Gasto nafta"       value={`- ${fmt(c.gastoNafta)}`} negative />
          <ResultRow label="Ganancia final"    value={fmt(c.gananciaFinal)} highlight big />

          {confirmDel === c.id ? (
            <div className="mt-5 bg-red-50 rounded-2xl p-3 space-y-2">
              <p className="text-sm text-red-600 font-medium text-center">Â¿Eliminar este cierre?</p>
              <div className="flex gap-2">
                <button onClick={() => setConfirmDel(null)}
                  className="flex-1 py-3 rounded-xl border-2 border-slate-300 text-slate-600 font-bold text-sm bg-white">
                  Cancelar
                </button>
                <button onClick={() => { onDelete(c.id); setSelected(null); setConfirmDel(null); }}
                  className="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold text-sm">
                  SÃ­, eliminar
                </button>
              </div>
            </div>
          ) : (
            <button onClick={() => setConfirmDel(c.id)}
              className="w-full mt-5 border-2 border-red-300 text-red-500 font-bold py-3 rounded-2xl text-sm hover:bg-red-50 transition-colors">
              Eliminar este cierre
            </button>
          )}
        </Card>
      </div>
    );
  }

  // â”€â”€ Vista lista â”€â”€
  return (
    <div className="space-y-3">
      <h2 className="text-lg font-bold text-slate-800">ğŸ“… Historial</h2>

      <Card className="p-4">
        <div className="flex gap-3">
          <select value={mes} onChange={(e) => { setMes(e.target.value); setSelected(null); setConfirmDel(null); }}
            className="flex-1 border border-slate-200 rounded-xl px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400">
            {meses.map((m, i) => <option key={i} value={String(i+1).padStart(2,"0")}>{m}</option>)}
          </select>
          <select value={anio} onChange={(e) => { setAnio(e.target.value); setSelected(null); setConfirmDel(null); }}
            className="w-28 border border-slate-200 rounded-xl px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400">
            {[2024,2025,2026,2027].map((y) => <option key={y}>{y}</option>)}
          </select>
        </div>
      </Card>

      {sorted.length === 0 && (
        <Card className="p-6 text-center text-slate-400 text-sm">No hay cierres para {meses[Number(mes)-1]} {anio}.</Card>
      )}
      {sorted.map((c) => (
        <Card key={c.id} className="overflow-hidden">
          {confirmDel === c.id ? (
            /* ConfirmaciÃ³n inline en la tarjeta */
            <div className="p-4 bg-red-50">
              <p className="text-sm text-red-600 font-medium mb-3 text-center">
                Â¿Eliminar el cierre del <strong>{fmtFecha(c.fecha)}</strong>?
              </p>
              <div className="flex gap-2">
                <button onClick={() => setConfirmDel(null)}
                  className="flex-1 py-3 rounded-xl border-2 border-slate-300 text-slate-600 font-bold text-sm bg-white">
                  Cancelar
                </button>
                <button onClick={() => { onDelete(c.id); setConfirmDel(null); }}
                  className="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold text-sm">
                  SÃ­, eliminar
                </button>
              </div>
            </div>
          ) : (
            <div className="flex items-stretch">
              {/* Info â€” toca para ver detalle */}
              <button onClick={() => setSelected(c.id)} className="flex-1 p-4 text-left active:bg-slate-50">
                <div className="flex justify-between items-center">
                  <div>
                    <div className="font-bold text-slate-800 text-base">{fmtFecha(c.fecha)}</div>
                    {c.noTrabajo
                      ? <div className="text-xs text-slate-400 mt-0.5">Sin actividad</div>
                      : <div className="text-sm text-slate-500 mt-0.5">Vendido: {fmt(c.totalVendido)}</div>
                    }
                  </div>
                  <div className="text-right mr-2">
                    <div className={`font-bold text-lg ${c.gananciaFinal >= 0 ? "text-emerald-600" : "text-red-500"}`}>
                      {fmt(c.gananciaFinal)}
                    </div>
                    <div className="text-xs text-slate-400">ganancia</div>
                  </div>
                </div>
              </button>
              {/* BotÃ³n eliminar lateral â€” toque directo lleva a confirmaciÃ³n */}
              <button onClick={() => setConfirmDel(c.id)}
                className="px-5 border-l border-slate-100 text-slate-300 hover:text-red-400 hover:bg-red-50 active:bg-red-100 transition-colors flex items-center justify-center text-xl">
                ğŸ—‘ï¸
              </button>
            </div>
          )}
        </Card>
      ))}
    </div>
  );
}

// â”€â”€â”€ Tab: Resumen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function GraficoSemanas({ cierres, mes, anio }) {
  // Agrupar cierres por semana del mes (1-4+)
  const semanas = [
    { label: "Sem 1", dias: [1,2,3,4,5,6,7] },
    { label: "Sem 2", dias: [8,9,10,11,12,13,14] },
    { label: "Sem 3", dias: [15,16,17,18,19,20,21] },
    { label: "Sem 4+", dias: [22,23,24,25,26,27,28,29,30,31] },
  ];

  const datos = semanas.map(s => {
    const total = cierres
      .filter(c => {
        const d = parseInt(c.fecha.split("-")[2]);
        return c.fecha.startsWith(`${anio}-${mes}`) && s.dias.includes(d);
      })
      .reduce((sum, c) => sum + (c.gananciaFinal || 0), 0);
    return { label: s.label, ganancia: total };
  }).filter(s => s.ganancia !== 0);

  if (datos.length === 0) return null;

  const maxVal = Math.max(...datos.map(d => Math.abs(d.ganancia)));

  return (
    <Card className="p-4">
      <h3 className="text-sm font-bold text-slate-700 mb-4">ğŸ“Š Ganancia por semana</h3>
      <div className="space-y-3">
        {datos.map((s, i) => {
          const pct = maxVal > 0 ? (Math.abs(s.ganancia) / maxVal) * 100 : 0;
          const positivo = s.ganancia >= 0;
          return (
            <div key={i}>
              <div className="flex justify-between text-xs text-slate-500 mb-1">
                <span className="font-medium">{s.label}</span>
                <span className={`font-bold ${positivo ? "text-emerald-600" : "text-red-500"}`}>
                  {fmt(s.ganancia)}
                </span>
              </div>
              <div className="w-full bg-slate-100 rounded-full h-5 overflow-hidden">
                <div
                  className={`h-5 rounded-full transition-all duration-500 ${positivo ? "bg-emerald-400" : "bg-red-400"}`}
                  style={{ width: `${pct}%`, minWidth: "4px" }}
                />
              </div>
            </div>
          );
        })}
      </div>
      <div className="mt-3 pt-3 border-t border-slate-100 flex justify-between text-xs text-slate-400">
        <span>Mejor semana: <span className="font-semibold text-emerald-600">{fmt(Math.max(...datos.map(d=>d.ganancia)))}</span></span>
        <span>{datos.length} semana{datos.length > 1 ? "s" : ""}</span>
      </div>
    </Card>
  );
}

function TabResumen({ cierres }) {
  const now  = new Date();
  const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio",
                 "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  const [mes,  setMes]  = useState(String(now.getMonth() + 1).padStart(2, "0"));
  const [anio, setAnio] = useState(String(now.getFullYear()));

  const impKey = (a, m) => `aguaImpuestos_${a}_${m}`;
  const loadImp = (a, m) => loadStorage(impKey(a, m), { dgi: "", bps: "" });

  const [dgi, setDgi] = useState(() => String(loadImp(String(now.getFullYear()), String(now.getMonth()+1).padStart(2,"0")).dgi || ""));
  const [bps, setBps] = useState(() => String(loadImp(String(now.getFullYear()), String(now.getMonth()+1).padStart(2,"0")).bps || ""));

  const handleMes = (v) => {
    setMes(v);
    const saved = loadImp(anio, v);
    setDgi(String(saved.dgi || ""));
    setBps(String(saved.bps || ""));
  };
  const handleAnio = (v) => {
    setAnio(v);
    const saved = loadImp(v, mes);
    setDgi(String(saved.dgi || ""));
    setBps(String(saved.bps || ""));
  };
  const handleDgi = (v) => {
    setDgi(v);
    saveStorage(impKey(anio, mes), { dgi: Number(v || 0), bps: Number(bps || 0) });
  };
  const handleBps = (v) => {
    setBps(v);
    saveStorage(impKey(anio, mes), { dgi: Number(dgi || 0), bps: Number(v || 0) });
  };

  const prefix  = `${anio}-${mes}`;
  const del_mes = cierres.filter((c) => c.fecha.startsWith(prefix));

  const totales = del_mes.reduce((acc, c) => ({
    vendido:  acc.vendido  + (c.totalVendido     || 0),
    credito:  acc.credito  + (c.descuentoCredito || 0),
    fabrica:  acc.fabrica  + (c.pagoFabrica      || 0),
    nafta:    acc.nafta    + (c.gastoNafta       || 0),
    ganancia: acc.ganancia + (c.gananciaFinal    || 0),
  }), { vendido: 0, credito: 0, fabrica: 0, nafta: 0, ganancia: 0 });

  const dgiVal = Number(dgi || 0);
  const bpsVal = Number(bps || 0);
  const gananciaFinalConImpuestos = totales.ganancia - dgiVal - bpsVal;

  return (
    <div className="space-y-4">
      <h2 className="text-lg font-bold text-slate-800">ğŸ“ˆ Resumen mensual</h2>

      <Card className="p-4">
        <div className="flex gap-3">
          <select value={mes} onChange={(e) => handleMes(e.target.value)}
            className="flex-1 border border-slate-200 rounded-xl px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400">
            {meses.map((m, i) => <option key={i} value={String(i+1).padStart(2,"0")}>{m}</option>)}
          </select>
          <select value={anio} onChange={(e) => handleAnio(e.target.value)}
            className="w-28 border border-slate-200 rounded-xl px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400">
            {[2024,2025,2026,2027].map((y) => <option key={y}>{y}</option>)}
          </select>
        </div>
      </Card>

      {del_mes.length === 0 ? (
        <Card className="p-6 text-center text-slate-400 text-sm">
          No hay cierres para {meses[Number(mes)-1]} {anio}.
        </Card>
      ) : (
        <>
          <Card className="p-4">
            <div className="text-sm text-slate-500 mb-3">
              {del_mes.length} cierre{del_mes.length > 1 ? "s" : ""} en {meses[Number(mes)-1]} {anio}
            </div>
            <ResultRow label="Total vendido"        value={fmt(totales.vendido)} />
            <ResultRow label="Pago a fÃ¡brica"       value={fmt(totales.fabrica)} />
            {totales.credito > 0 && (
              <ResultRow label="Descuento crÃ©ditos" value={`- ${fmt(totales.credito)}`} negative />
            )}
            <ResultRow label="Gasto nafta"           value={`- ${fmt(totales.nafta)}`} negative />
            <ResultRow label="Ganancia antes de impuestos" value={fmt(totales.ganancia)} big />
          </Card>

          <Card className="p-4">
            <h3 className="text-base font-bold text-slate-700 mb-3">ğŸ§¾ Gastos mensuales</h3>
            <div className="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">DGI ($)</label>
                <input type="number" inputMode="decimal" min="0" placeholder="0"
                  value={dgi} onChange={(e) => handleDgi(e.target.value)}
                  className="w-full border border-slate-200 rounded-xl px-3 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">BPS ($)</label>
                <input type="number" inputMode="decimal" min="0" placeholder="0"
                  value={bps} onChange={(e) => handleBps(e.target.value)}
                  className="w-full border border-slate-200 rounded-xl px-3 py-3 text-lg focus:outline-none focus:ring-2 focus:ring-blue-400" />
              </div>
            </div>
            {(dgiVal > 0 || bpsVal > 0) && (
              <div className="text-xs text-slate-400 text-right mb-1">
                Total descontado: {fmt(dgiVal + bpsVal)}
              </div>
            )}
            <div className="flex justify-between items-center pt-3 border-t border-slate-200">
              <span className="font-bold text-slate-800 text-base">Ganancia final del mes</span>
              <span className={`font-extrabold text-2xl tabular-nums ${gananciaFinalConImpuestos >= 0 ? "text-emerald-600" : "text-red-500"}`}>
                {fmt(gananciaFinalConImpuestos)}
              </span>
            </div>
          </Card>
        </>
      )}
    </div>
  );
}

// â”€â”€â”€ Tab: Reportes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BarChart({ datos, colorPos = "#34d399", colorNeg = "#f87171", height = 160 }) {
  if (!datos.length) return null;
  const maxVal = Math.max(...datos.map(d => Math.abs(d.valor)), 1);
  return (
    <div className="flex items-end gap-1.5" style={{ height }}>
      {datos.map((d, i) => {
        const pct = (Math.abs(d.valor) / maxVal) * 90;
        const color = d.valor >= 0 ? colorPos : colorNeg;
        return (
          <div key={i} className="flex-1 flex flex-col items-center gap-1" style={{ height: "100%" }}>
            <div className="flex-1 flex items-end w-full">
              <div
                className="w-full rounded-t-md transition-all duration-500 relative group"
                style={{ height: `${pct}%`, minHeight: 4, backgroundColor: color }}
              >
                <div className="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold whitespace-nowrap hidden group-hover:block bg-slate-800 text-white px-1.5 py-0.5 rounded z-10">
                  {fmt(d.valor)}
                </div>
              </div>
            </div>
            <span className="text-xs text-slate-500 text-center leading-tight" style={{ fontSize: 10 }}>{d.label}</span>
          </div>
        );
      })}
    </div>
  );
}

function ReporteAnual({ cierres }) {
  const now  = new Date();
  const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio",
                 "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  const [anio, setAnio] = useState(String(now.getFullYear()));

  // Todos los meses del aÃ±o seleccionado, descontando DGI+BPS guardados
  const datosAnuales = meses.map((nombre, i) => {
    const m   = String(i + 1).padStart(2, "0");
    const pfx = `${anio}-${m}`;
    const gan = cierres
      .filter(c => c.fecha.startsWith(pfx) && !c.noTrabajo)
      .reduce((s, c) => s + (c.gananciaFinal || 0), 0);
    const imp = loadStorage(`aguaImpuestos_${anio}_${m}`, { dgi: 0, bps: 0 });
    return { label: nombre.slice(0, 3), valor: gan - (imp.dgi || 0) - (imp.bps || 0) };
  });

  const totalAnio  = datosAnuales.reduce((s, d) => s + d.valor, 0);
  const mesesConDatos = datosAnuales.filter(d => d.valor !== 0);
  const mejorMes   = mesesConDatos.length ? datosAnuales.reduce((a, b) => b.valor > a.valor ? b : a, datosAnuales[0]) : null;
  const promMes    = mesesConDatos.length ? totalAnio / mesesConDatos.length : 0;

  return (
    <div className="space-y-3">
      {/* Header reporte */}
      <div className="flex items-center gap-3 px-1">
        <div className="w-1 h-10 bg-blue-500 rounded-full" />
        <div>
          <h3 className="text-base font-extrabold text-slate-800">Reporte Anual</h3>
          <p className="text-xs text-slate-400">Ganancia mes a mes durante el aÃ±o</p>
        </div>
        <div className="ml-auto">
          <select value={anio} onChange={e => setAnio(e.target.value)}
            className="border border-slate-200 rounded-xl px-3 py-2 text-base font-semibold focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white">
            {[2024,2025,2026,2027].map(y => <option key={y}>{y}</option>)}
          </select>
        </div>
      </div>

      {/* Stats anuales */}
      {mesesConDatos.length > 0 && (
        <div className="grid grid-cols-3 gap-2">
          {[
            { label: "Total aÃ±o",    valor: fmt(totalAnio),          color: "text-blue-600" },
            { label: "Prom. mensual", valor: fmt(promMes),           color: "text-emerald-600" },
            { label: "Mejor mes",    valor: mejorMes ? mejorMes.label : "-", color: "text-amber-500" },
          ].map((s, i) => (
            <Card key={i} className="p-3 text-center">
              <div className={`text-base font-extrabold ${s.color}`}>{s.valor}</div>
              <div className="text-xs text-slate-400 mt-0.5 leading-tight">{s.label}</div>
            </Card>
          ))}
        </div>
      )}

      {/* GrÃ¡fico */}
      <Card className="p-4">
        {datosAnuales.every(d => d.valor === 0) ? (
          <p className="text-center text-slate-400 text-sm py-6">Sin datos para {anio}.</p>
        ) : (
          <>
            <BarChart datos={datosAnuales} height={180} />
            <div className="mt-4 space-y-1.5 border-t border-slate-100 pt-3">
              {datosAnuales.map((d, i) => d.valor !== 0 && (
                <div key={i} className="flex justify-between items-center text-sm">
                  <span className="text-slate-600">{meses[i]}</span>
                  <span className={`font-bold tabular-nums ${d.valor >= 0 ? "text-emerald-600" : "text-red-500"}`}>
                    {fmt(d.valor)}
                  </span>
                </div>
              ))}
              <div className="flex justify-between items-center pt-2 border-t border-slate-200 text-sm font-bold">
                <span className="text-slate-800">Total {anio}</span>
                <span className={`text-base ${totalAnio >= 0 ? "text-emerald-600" : "text-red-500"}`}>{fmt(totalAnio)}</span>
              </div>
            </div>
          </>
        )}
      </Card>
    </div>
  );
}

function ReporteMensual({ cierres }) {
  const now   = new Date();
  const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio",
                 "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  const [mes,  setMes]  = useState(String(now.getMonth() + 1).padStart(2, "0"));
  const [anio, setAnio] = useState(String(now.getFullYear()));

  const prefix  = `${anio}-${mes}`;
  const del_mes = cierres.filter(c => c.fecha.startsWith(prefix) && !c.noTrabajo);

  const semanas = [
    { label: "Semana 1", rango: "dÃ­as 1 â€“ 7",   dias: [1,2,3,4,5,6,7] },
    { label: "Semana 2", rango: "dÃ­as 8 â€“ 14",  dias: [8,9,10,11,12,13,14] },
    { label: "Semana 3", rango: "dÃ­as 15 â€“ 21", dias: [15,16,17,18,19,20,21] },
    { label: "Semana 4", rango: "dÃ­as 22 â€“ fin", dias: [22,23,24,25,26,27,28,29,30,31] },
  ];

  const datosSemanas = semanas.map(s => ({
    label: s.label.replace("Semana ", "Sem "),
    rango: s.rango,
    valor: del_mes
      .filter(c => s.dias.includes(parseInt(c.fecha.split("-")[2])))
      .reduce((sum, c) => sum + (c.gananciaFinal || 0), 0),
    cierres: del_mes.filter(c => s.dias.includes(parseInt(c.fecha.split("-")[2]))).length,
  }));

  const totalMes  = del_mes.reduce((s, c) => s + (c.gananciaFinal || 0), 0);
  const imp       = loadStorage(`aguaImpuestos_${anio}_${mes}`, { dgi: 0, bps: 0 });
  const totalImp  = (imp.dgi || 0) + (imp.bps || 0);
  const totalNeto = totalMes - totalImp;
  const promDia   = del_mes.length ? totalNeto / del_mes.length : 0;
  const mejorDia  = del_mes.length ? Math.max(...del_mes.map(c => c.gananciaFinal || 0)) : 0;

  return (
    <div className="space-y-3">
      {/* Header reporte */}
      <div className="flex items-center gap-3 px-1">
        <div className="w-1 h-10 bg-emerald-500 rounded-full" />
        <div>
          <h3 className="text-base font-extrabold text-slate-800">Reporte Mensual</h3>
          <p className="text-xs text-slate-400">Desglose semana a semana del mes</p>
        </div>
      </div>

      {/* Selector mes/aÃ±o */}
      <Card className="p-4">
        <div className="flex gap-3">
          <select value={mes} onChange={e => setMes(e.target.value)}
            className="flex-1 border border-slate-200 rounded-xl px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-emerald-400">
            {meses.map((m, i) => <option key={i} value={String(i+1).padStart(2,"0")}>{m}</option>)}
          </select>
          <select value={anio} onChange={e => setAnio(e.target.value)}
            className="w-28 border border-slate-200 rounded-xl px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-emerald-400">
            {[2024,2025,2026,2027].map(y => <option key={y}>{y}</option>)}
          </select>
        </div>
      </Card>

      {del_mes.length === 0 ? (
        <Card className="p-6 text-center text-slate-400 text-sm">
          No hay cierres para {meses[Number(mes)-1]} {anio}.
        </Card>
      ) : (
        <>
          {/* Stats del mes */}
          <div className="grid grid-cols-3 gap-2">
            {[
              { label: "DÃ­as trabajados", valor: del_mes.length, fmt: v => v,       color: "text-emerald-600" },
              { label: "Promedio/dÃ­a",    valor: promDia,         fmt: v => fmt(v),  color: "text-blue-600"    },
              { label: "Mejor dÃ­a",       valor: mejorDia,        fmt: v => fmt(v),  color: "text-amber-500"   },
            ].map((s, i) => (
              <Card key={i} className="p-3 text-center">
                <div className={`text-base font-extrabold ${s.color}`}>{s.fmt(s.valor)}</div>
                <div className="text-xs text-slate-400 mt-0.5 leading-tight">{s.label}</div>
              </Card>
            ))}
          </div>

          {/* GrÃ¡fico semanas */}
          <Card className="p-4">
            <BarChart datos={datosSemanas} height={180} colorPos="#34d399" colorNeg="#f87171" />
            <div className="mt-4 space-y-2 border-t border-slate-100 pt-3">
              {datosSemanas.map((s, i) => (
                <div key={i} className={`rounded-xl p-3 ${s.valor === 0 ? "bg-slate-50" : s.valor > 0 ? "bg-emerald-50" : "bg-red-50"}`}>
                  <div className="flex justify-between items-center">
                    <div>
                      <span className="font-semibold text-slate-700 text-sm">{semanas[i].label}</span>
                      <span className="text-xs text-slate-400 ml-2">{s.rango}</span>
                    </div>
                    <span className={`font-bold text-sm tabular-nums ${s.valor > 0 ? "text-emerald-600" : s.valor < 0 ? "text-red-500" : "text-slate-400"}`}>
                      {s.valor === 0 ? "â€”" : fmt(s.valor)}
                    </span>
                  </div>
                  {s.cierres > 0 && (
                    <div className="text-xs text-slate-400 mt-0.5">{s.cierres} cierre{s.cierres > 1 ? "s" : ""}</div>
                  )}
                </div>
              ))}
              <div className="flex justify-between items-center pt-2 border-t border-slate-200 px-1">
                <span className="font-bold text-slate-800">Ganancia bruta</span>
                <span className="font-semibold text-slate-600 tabular-nums">{fmt(totalMes)}</span>
              </div>
              {totalImp > 0 && (
                <div className="flex justify-between items-center px-1 text-sm">
                  <span className="text-slate-500">DGI + BPS</span>
                  <span className="text-red-400 tabular-nums">- {fmt(totalImp)}</span>
                </div>
              )}
              <div className="flex justify-between items-center px-1 pt-1 border-t border-slate-300">
                <span className="font-extrabold text-slate-800">Ganancia final</span>
                <span className={`font-extrabold text-xl tabular-nums ${totalNeto >= 0 ? "text-emerald-600" : "text-red-500"}`}>
                  {fmt(totalNeto)}
                </span>
              </div>
            </div>
          </Card>
        </>
      )}
    </div>
  );
}

function TabReportes({ cierres }) {
  return (
    <div className="space-y-8">
      <div>
        <div className="flex items-center gap-2 mb-4">
          <span className="text-lg">ğŸ“Š</span>
          <h2 className="text-lg font-bold text-slate-800">Reportes</h2>
        </div>
        <div className="h-px bg-slate-200 mb-6" />

        {/* â”€â”€ Reporte 1 â”€â”€ */}
        <ReporteAnual cierres={cierres} />

        {/* Divisor */}
        <div className="flex items-center gap-3 my-8">
          <div className="flex-1 h-px bg-slate-200" />
          <span className="text-xs text-slate-400 font-medium px-2">REPORTE MENSUAL</span>
          <div className="flex-1 h-px bg-slate-200" />
        </div>

        {/* â”€â”€ Reporte 2 â”€â”€ */}
        <ReporteMensual cierres={cierres} />
      </div>
    </div>
  );
}

// â”€â”€â”€ Tab: ConfiguraciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TabConfig({ config, onSave }) {
  const [draft, setDraft] = useState(() => JSON.parse(JSON.stringify(config)));
  const [saved, setSaved] = useState(false);

  const updateProd = (id, field, val) => {
    setDraft((prev) => ({
      ...prev,
      productos: prev.productos.map((p) => p.id === id ? { ...p, [field]: val } : p),
    }));
    setSaved(false);
  };

  const handleSave = () => {
    onSave({
      ...draft,
      gastoNafta: Number(draft.gastoNafta),
      productos: draft.productos.map((p) => ({
        ...p,
        precioVenta:    Number(p.precioVenta),
        gananciaUnidad: Number(p.gananciaUnidad),
      })),
    });
    setSaved(true);
  };

  return (
    <div className="space-y-4">
      <h2 className="text-lg font-bold text-slate-800">âš™ï¸ ConfiguraciÃ³n</h2>
      {draft.productos.map((p) => (
        <Card key={p.id} className="p-4">
          <div className="font-bold text-slate-800 mb-3 flex items-center gap-2"><ProductIcon id={p.id} size={28} /> {p.nombre}</div>
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="block text-xs text-slate-500 mb-1">Precio venta ($)</label>
              <input type="number" inputMode="decimal" value={p.precioVenta}
                onChange={(e) => updateProd(p.id, "precioVenta", e.target.value)}
                className="w-full border border-slate-200 rounded-xl px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400" />
            </div>
            <div>
              <label className="block text-xs text-slate-500 mb-1">Tu ganancia ($)</label>
              <input type="number" inputMode="decimal" value={p.gananciaUnidad}
                onChange={(e) => updateProd(p.id, "gananciaUnidad", e.target.value)}
                className="w-full border border-slate-200 rounded-xl px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400" />
            </div>
          </div>
          <div className="mt-2 text-xs text-slate-400">
            Pago a fÃ¡brica: {fmt(Number(p.precioVenta) - Number(p.gananciaUnidad))} c/u
          </div>
        </Card>
      ))}

      <Card className="p-4">
        <label className="block text-sm font-bold text-slate-800 mb-2"><img src={NAFTA_GIF} style={{display:"inline",verticalAlign:"middle",marginRight:"4px",imageRendering:"pixelated",width:"24px",height:"24px"}} alt="nafta"/> Gasto fijo de nafta</label>
        <input type="number" inputMode="decimal" value={draft.gastoNafta}
          onChange={(e) => { setDraft((p) => ({ ...p, gastoNafta: e.target.value })); setSaved(false); }}
          className="w-full border border-slate-200 rounded-xl px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400" />
      </Card>

      <button onClick={handleSave}
        className={`w-full text-white font-bold py-4 rounded-2xl text-base transition-colors ${saved ? "bg-emerald-500" : "bg-blue-600 hover:bg-blue-700"}`}>
        {saved ? "Guardado" : "Guardar configuraciÃ³n"}
      </button>
    </div>
  );
}

// â”€â”€â”€ Tab: Exportar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TabExportar({ cierres }) {
  const now   = new Date();
  const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio",
                 "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  const [mes,  setMes]  = useState(String(now.getMonth() + 1).padStart(2, "0"));
  const [anio, setAnio] = useState(String(now.getFullYear()));
  const prefix  = `${anio}-${mes}`;
  const del_mes = cierres.filter(c => c.fecha.startsWith(prefix));

  const r2 = (v) => Math.round((Number(v) || 0) * 100) / 100;
  const fmtNum = (v) => String(r2(v)).replace(".", ",");

  const [exportado, setExportado] = useState(false);

  const handleExportar = () => {
    if (del_mes.length === 0) return;
    const cols = [
      "Fecha", "BidÃ³n 20L", "BidÃ³n 12L", "CajÃ³n Soda", "CrÃ©dito",
      "Total Vendido", "Pago FÃ¡brica", "Descuento CrÃ©dito", "Gasto Nafta", "Ganancia Final"
    ];
    const filas = [...del_mes]
      .sort((a, b) => a.fecha.localeCompare(b.fecha))
      .map(c => [
        c.fecha,
        c.cantidades?.bidon20  ?? 0,
        c.cantidades?.bidon12  ?? 0,
        c.cantidades?.cajon    ?? 0,
        c.credito              ?? 0,
        fmtNum(c.totalVendido),
        fmtNum(c.pagoFabrica),
        fmtNum(c.descuentoCredito),
        fmtNum(c.gastoNafta),
        fmtNum(c.gananciaFinal),
      ]);
    const csvRows = [cols, ...filas];
    const imp    = loadStorage(`aguaImpuestos_${anio}_${mes}`, { dgi: 0, bps: 0 });
    const dgiVal = Number(imp.dgi || 0);
    const bpsVal = Number(imp.bps || 0);
    const bruto  = del_mes.reduce((s, c) => s + (c.gananciaFinal || 0), 0);
    const neto   = bruto - dgiVal - bpsVal;
    csvRows.push([""]);
    csvRows.push(["Ganancia bruta", "", "", "", "", "", "", "", "", fmtNum(bruto)]);
    if (dgiVal > 0) csvRows.push(["DGI", "", "", "", "", "", "", "", "", fmtNum(-dgiVal)]);
    if (bpsVal > 0) csvRows.push(["BPS", "", "", "", "", "", "", "", "", fmtNum(-bpsVal)]);
    csvRows.push(["Ganancia final", "", "", "", "", "", "", "", "", fmtNum(neto)]);
    const csvText = csvRows.map(row =>
      row.map(v => { const s = String(v ?? ""); return s.includes(";") ? `"${s}"` : s; }).join(";")
    );
    const csv  = "\uFEFFsep=;\r\n" + csvText.join("\r\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href     = url;
    a.download = `agua-reparto-${meses[Number(mes)-1].toLowerCase()}-${anio}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    setExportado(true);
    setTimeout(() => setExportado(false), 3000);
  };

  const handleCompartirTexto = () => {
    if (del_mes.length === 0) return;
    const imp    = loadStorage(`aguaImpuestos_${anio}_${mes}`, { dgi: 0, bps: 0 });
    const dgiVal = Number(imp.dgi || 0);
    const bpsVal = Number(imp.bps || 0);
    const bruto  = del_mes.reduce((s, c) => s + (c.gananciaFinal || 0), 0);
    const neto   = bruto - dgiVal - bpsVal;
    const totalVendido  = del_mes.reduce((s, c) => s + (c.totalVendido || 0), 0);
    const diasTrabajados = del_mes.filter(c => !c.noTrabajo).length || del_mes.length;
    const promedio      = diasTrabajados > 0 ? neto / diasTrabajados : 0;
    const hoy           = new Date();
    const fechaEnvio    = `${String(hoy.getDate()).padStart(2,"0")}/${String(hoy.getMonth()+1).padStart(2,"0")}/${hoy.getFullYear()}`;
    let texto = `ğŸš° *Resumen ${meses[Number(mes)-1]} ${anio}*\n`;
    texto += `ğŸ“… ${fechaEnvio}\n`;
    texto += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    texto += `ğŸ’° Total vendido: ${fmt(totalVendido)}\n`;
    texto += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    texto += `ğŸ“Š Ganancia bruta: ${fmt(bruto)}\n`;
    if (dgiVal > 0) texto += `ğŸ›ï¸ DGI: -${fmt(dgiVal)}\n`;
    if (bpsVal > 0) texto += `ğŸ›ï¸ BPS: -${fmt(bpsVal)}\n`;
    texto += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    texto += `âœ… *Ganancia final: ${fmt(neto)}*\n`;
    texto += `ğŸ“ˆ Promedio por dÃ­a: ${fmt(promedio)}`;
    const encoded = encodeURIComponent(texto);
    window.open(`https://wa.me/?text=${encoded}`, "_blank");
  };
  // Calcular totales del mes para preview
  const totales = del_mes.reduce((acc, c) => ({
    vendido:  acc.vendido  + (c.totalVendido  || 0),
    ganancia: acc.ganancia + (c.gananciaFinal || 0),
  }), { vendido: 0, ganancia: 0 });

  return (
    <div className="space-y-4">
      <h2 className="text-lg font-bold text-slate-800">ğŸ“¥ Exportar a Excel</h2>

      {/* Selector mes/aÃ±o */}
      <Card className="p-4">
        <p className="text-sm text-slate-500 mb-3">SeleccionÃ¡ el mes que querÃ©s exportar</p>
        <div className="flex gap-3">
          <select value={mes} onChange={e => { setMes(e.target.value); setExportado(false); }}
            className="flex-1 border border-slate-200 rounded-xl px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400">
            {meses.map((m, i) => <option key={i} value={String(i+1).padStart(2,"0")}>{m}</option>)}
          </select>
          <select value={anio} onChange={e => { setAnio(e.target.value); setExportado(false); }}
            className="w-28 border border-slate-200 rounded-xl px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400">
            {[2024,2025,2026,2027].map(y => <option key={y}>{y}</option>)}
          </select>
        </div>
      </Card>

      {/* Preview del mes */}
      <Card className="p-4">
        {del_mes.length === 0 ? (
          <div className="text-center py-4 text-slate-400 text-sm">
            No hay cierres para {meses[Number(mes)-1]} {anio}.
          </div>
        ) : (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <span className="text-sm text-slate-500">Cierres registrados</span>
              <span className="font-bold text-slate-800 text-lg">{del_mes.length}</span>
            </div>
            <div className="flex items-center justify-between">
              <span className="text-sm text-slate-500">Total vendido</span>
              <span className="font-semibold text-slate-700">{fmt(totales.vendido)}</span>
            </div>
            <div className="flex items-center justify-between">
              <span className="text-sm text-slate-500">Ganancia del mes</span>
              <span className={`font-bold ${totales.ganancia >= 0 ? "text-emerald-600" : "text-red-500"}`}>{fmt(totales.ganancia)}</span>
            </div>
            <div className="pt-1 border-t border-slate-100 text-xs text-slate-400">
              Archivo: <span className="font-medium text-slate-500">agua-reparto-{meses[Number(mes)-1].toLowerCase()}-{anio}.csv</span>
            </div>
          </div>
        )}
      </Card>

      {/* Botones */}
      <div className="space-y-3">
        <button
          onClick={handleExportar}
          disabled={del_mes.length === 0}
          className={`w-full font-bold py-4 rounded-2xl text-base transition-all ${
            exportado
              ? "bg-blue-400 scale-95 text-white"
              : del_mes.length === 0
              ? "bg-slate-200 text-slate-400 cursor-not-allowed"
              : "bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white"
          }`}>
          {exportado ? "âœ“ Descargado" : "ğŸ“¥ Descargar"}
        </button>
        <button
          onClick={handleCompartirTexto}
          disabled={del_mes.length === 0}
          className={`w-full font-bold py-4 rounded-2xl text-base transition-all ${
            del_mes.length === 0
              ? "bg-slate-200 text-slate-400 cursor-not-allowed"
              : "bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white"
          }`}>
          ğŸ’¬ Compartir resumen por WhatsApp
        </button>
      </div>
    </div>
  );
}

// â”€â”€â”€ App principal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [user,        setUser]        = useState(null);
  const [authReady,   setAuthReady]   = useState(false);
  const [dataLoading, setDataLoading] = useState(false);
  const [activeTab,   setActiveTab]   = useState(0);
  const [dark,        setDark]        = useState(() => loadStorage("aguaDarkMode", false));
  const [config,      setConfig]      = useState(DEFAULT_CONFIG);
  const [cierres,     setCierres]     = useState([]);

  useEffect(() => {
    return auth.onAuthStateChanged(async (u) => {
      setUser(u);
      if (u) {
        setDataLoading(true);
        try {
          const [cfg, cls] = await Promise.all([fsLoadConfig(u.uid), fsLoadCierres(u.uid)]);
          setConfig(cfg);
          setCierres(cls);
        } catch(e) { console.error("Error cargando datos:", e); }
        setDataLoading(false);
      } else {
        setConfig(DEFAULT_CONFIG);
        setCierres([]);
      }
      setAuthReady(true);
    });
  }, []);

  const toggleDark = () => setDark(p => { const n = !p; saveStorage("aguaDarkMode", n); return n; });

  const saveCierre = useCallback(async (cierre) => {
    await fsSaveCierre(user.uid, cierre);
    setCierres((prev) => [...prev, cierre]);
  }, [user]);

  const deleteCierre = useCallback(async (id) => {
    await fsDeleteCierre(user.uid, id);
    setCierres((prev) => prev.filter((c) => c.id !== id));
  }, [user]);

  const saveConfig = useCallback(async (newConfig) => {
    setConfig(newConfig);
    await fsSaveConfig(user.uid, newConfig);
  }, [user]);

  const handleLogout = () => auth.signOut();

  const exportarExcel = () => {
    const fecha = new Date().toISOString().split("T")[0];

    // Encabezados
    const cols = [
      "Fecha", "BidÃ³n 20L", "BidÃ³n 12L", "CajÃ³n Soda", "CrÃ©dito",
      "Total Vendido", "Pago FÃ¡brica", "Descuento CrÃ©dito", "Gasto Nafta", "Ganancia Final", "No trabajÃ³"
    ];

    const r2 = (v) => Math.round((Number(v) || 0) * 100) / 100;

    const filas = [...cierres]
      .sort((a, b) => a.fecha.localeCompare(b.fecha))
      .map(c => [
        c.fecha,
        c.cantidades?.bidon20  ?? 0,
        c.cantidades?.bidon12  ?? 0,
        c.cantidades?.cajon    ?? 0,
        c.credito              ?? 0,
        r2(c.totalVendido),
        r2(c.pagoFabrica),
        r2(c.descuentoCredito),
        r2(c.gastoNafta),
        r2(c.gananciaFinal),
        c.noTrabajo ? "SÃ­" : "No",
      ]);

    // Construir CSV con separador ; y coma decimal (compatible con Excel en espaÃ±ol)
    const csvRows = [cols, ...filas].map(row =>
      row.map((v, i) => {
        // Columnas numÃ©ricas con decimales: reemplazar punto por coma
        if (i >= 5 && i <= 9 && typeof v === "number") {
          return String(v).replace(".", ",");
        }
        const s = String(v ?? "");
        return s.includes(";") || s.includes('"') ? `"${s.replace(/"/g, '""')}"` : s;
      }).join(";")
    );

    // BOM para que Excel abra con tildes correctas
    const bom  = "\uFEFF";
    const csv  = bom + csvRows.join("\r\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href     = url;
    a.download = `agua-reparto-${fecha}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const tabIcons = ["ğŸ“‹", "ğŸ“…", "ğŸ“ˆ", "ğŸ“Š", "ğŸ“¥", "âš™ï¸"];

  if (!authReady) return (
    <div className="min-h-screen bg-slate-50 flex items-center justify-center">
      <p className="text-slate-400 text-sm">Cargando...</p>
    </div>
  );

  if (!user) return <LoginScreen />;

  if (dataLoading) return (
    <div className="min-h-screen bg-slate-50 flex items-center justify-center">
      <div className="text-center">
        <div className="text-4xl mb-3">ğŸ’§</div>
        <p className="text-slate-400 text-sm">Cargando datos...</p>
      </div>
    </div>
  );

  return (
    <div className={`min-h-screen bg-slate-50${dark ? " dk" : ""}`}>
      <header className="bg-blue-600 text-white px-4 pb-3 pt-4 shadow-lg">
        <div className="max-w-lg mx-auto flex items-center justify-between">
          <div>
            <h1 className="text-xl font-extrabold tracking-tight">ğŸ’§ Aqua Control</h1>
            <p className="text-blue-200 text-xs">GestiÃ³n de cierres diarios</p>
          </div>
          <div className="flex items-center gap-2">
            <button onClick={toggleDark}
              className="text-xl p-2 rounded-full hover:bg-blue-500 active:bg-blue-400 transition-colors select-none"
              title={dark ? "Modo claro" : "Modo oscuro"}>
              {dark ? "â˜€ï¸" : "ğŸŒ™"}
            </button>
            <button onClick={handleLogout}
              className="text-sm px-3 py-1.5 rounded-full bg-blue-700 hover:bg-blue-800 transition-colors font-medium">
              Salir
            </button>
          </div>
        </div>
      </header>

      <nav className={`bg-white border-b border-slate-200 shadow-sm sticky top-0 z-10${dark ? " dk-nav" : ""}`}>
        <div className="max-w-lg mx-auto flex">
          {TABS.map((tab, i) => (
            <button key={tab} onClick={() => setActiveTab(i)}
              className={`flex-1 py-3 text-xs font-semibold flex flex-col items-center gap-0.5 transition-colors border-b-2 ${
                activeTab === i
                  ? dark ? "border-blue-400 text-blue-400" : "border-blue-600 text-blue-600"
                  : dark ? "border-transparent text-slate-500" : "border-transparent text-slate-400 hover:text-slate-600"
              }`}>
              <span className="text-base">{tabIcons[i]}</span>
              {tab}
            </button>
          ))}
        </div>
      </nav>

      <main className="max-w-lg mx-auto px-4 py-5 pb-10">
        {activeTab === 0 && <TabCierre    config={config} cierres={cierres} onSave={saveCierre} />}
        {activeTab === 1 && <TabHistorial cierres={cierres} config={config} onDelete={deleteCierre} />}
        {activeTab === 2 && <TabResumen   cierres={cierres} />}
        {activeTab === 3 && <TabReportes  cierres={cierres} />}
        {activeTab === 4 && <TabExportar  cierres={cierres} />}
        {activeTab === 5 && <TabConfig    config={config} onSave={saveConfig} />}
      </main>
    </div>
  );
}


    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
